# Do not modify this file!  It was generated by ‚Äònixos-generate-config‚Äô
# and may be overwritten by future invocations.  Please make changes
# to /etc/nixos/configuration.nix instead.
{ config, lib, pkgs, modulesPath, ... }:

{
  imports =
    [ (modulesPath + "/installer/scan/not-detected.nix")
    ];

  boot.initrd.availableKernelModules = [ "xhci_pci" "nvme" "usb_storage" "sd_mod" "rtsx_pci_sdmmc" ];
  boot.initrd.kernelModules = [ "i915" ];
  boot.kernelModules = [ "kvm-intel" ];
  boot.extraModulePackages = [ ];

  fileSystems."/" =
    { device = "/dev/disk/by-uuid/b019f5c3-5876-4dcc-afad-cd668be6a514";
      fsType = "ext4";
    };

  fileSystems."/boot" =
    { device = "/dev/disk/by-uuid/F6B8-FAA7";
      fsType = "vfat";
      options = [ "fmask=0077" "dmask=0077" ];
    };

  swapDevices = [ ];

  # Enables DHCP on each ethernet and wireless interface. In case of scripted networking
  # (the default) this is the recommended approach. When using systemd-networkd it's
  # still possible to use this option, but it's recommended to use it in conjunction
  # with explicit per-interface declarations with `networking.interfaces.<interface>.useDHCP`.
  networking.useDHCP = lib.mkDefault true;
  # networking.interfaces.enp0s31f6.useDHCP = lib.mkDefault true;
  # networking.interfaces.wlp0s20f3.useDHCP = lib.mkDefault true;

  nixpkgs.hostPlatform = lib.mkDefault "x86_64-linux";
  hardware.cpu.intel.updateMicrocode = lib.mkDefault config.hardware.enableRedistributableFirmware;

###############
#   Graphic   #
###############

  # 2. Graphics Enable: ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Mesa ‡πÅ‡∏•‡∏∞ OpenGL
  hardware.graphics = {
    enable = true;
    
    # ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç! ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 32-bit (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Steam, Wine, Lutris)
    enable32Bit = true; 

    # 3. Hardware Acceleration (VAAPI): ‡πÉ‡∏´‡πâ GPU ‡∏ä‡πà‡∏ß‡∏¢‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
    extraPackages = with pkgs; [
      intel-media-driver   # Driver ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Intel ‡∏£‡∏∏‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà (Broadwell+) *‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ*
      intel-vaapi-driver   # Driver ‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏≤ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô Fallback ‡πÅ‡∏ï‡πà‡∏õ‡∏Å‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß)
      libvdpau-va-gl       # ‡πÅ‡∏õ‡∏•‡∏á VDPAU (‡∏Ç‡∏≠‡∏á Nvidia ‡πÄ‡∏î‡∏¥‡∏°) ‡πÉ‡∏´‡πâ‡∏ß‡∏¥‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô VAAPI
    ];
  };

  # 4. System Environment Variables (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏≤‡∏á‡πÅ‡∏≠‡∏õ‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å Driver)
  environment.sessionVariables = { 
    # ‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ Firefox/Chrome ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Driver ‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
    LIBVA_DRIVER_NAME = "iHD"; 
  };

  # 5. Tools: ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÑ‡∏ß‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ GPU
  environment.systemPackages = with pkgs; [
    # mesa# ‡∏°‡∏µ glxinfo ‡πÑ‡∏ß‡πâ‡πÄ‡∏ä‡πá‡∏Ñ OpenGL
	mesa-demos
    vulkan-tools    # ‡∏°‡∏µ vulkaninfo ‡πÑ‡∏ß‡πâ‡πÄ‡∏ä‡πá‡∏Ñ Vulkan
    intel-gpu-tools # ‡∏°‡∏µ intel_gpu_top ‡πÑ‡∏ß‡πâ‡∏î‡∏π Load ‡∏Ç‡∏≠‡∏á GPU (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô htop ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡πá‡∏ô GPU)
    libva-utils     # ‡∏°‡∏µ vainfo ‡πÑ‡∏ß‡πâ‡πÄ‡∏ä‡πá‡∏Ñ Video Codec
  ];

  boot.kernel.sysctl = {
    "net.ipv4.tcp_congestion_control" = lib.mkForce "bbr";
    "net.core.default_qdisc" = lib.mkForce "fq";
  };

  # 2. üî• ‡∏¢‡∏≤‡πÅ‡∏£‡∏á: Config Driver Intel ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ThinkPad)
  boot.extraModprobeConfig = ''
    # ‡∏õ‡∏¥‡∏î Power Management ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì
    options iwlwifi power_save=0
    
    # ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏° Packet (Aggregation) ‡∏ö‡∏≤‡∏á‡∏ó‡∏µ‡∏ä‡πà‡∏ß‡∏¢‡∏•‡∏î Jitter ‡πÉ‡∏ô‡πÄ‡∏ô‡πá‡∏ï‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ô‡∏¥‡πà‡∏á
    options iwlwifi 11n_disable=1
    
    # ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î Active ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤ (‡∏´‡πâ‡∏≤‡∏° Sleep)
    options iwlmvm power_scheme=1
  '';
}
